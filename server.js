const express = require("express");
const http = require("http");
const path = require("path");
const { Server } = require("socket.io");
const mongoose = require("mongoose");

const app = express();
const server = http.createServer(app);
const io = new Server(server);

// ÐŸÑ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ Ð´Ð¾ MongoDB
const mongoURI = process.env.MONGO_URI; // Ð·Ð¼Ñ–Ð½Ð½Ð° ÑÐµÑ€ÐµÐ´Ð¾Ð²Ð¸Ñ‰Ð° Ð² Render
mongoose.connect(mongoURI, { useNewUrlParser: true, useUnifiedTopology: true })
  .then(() => console.log("âœ… MongoDB connected"))
  .catch(err => console.error("âŒ MongoDB connection error:", err));

// Ð¡Ñ…ÐµÐ¼Ð° Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½ÑŒ
const messageSchema = new mongoose.Schema({
  from: String,   // "user" Ð°Ð±Ð¾ "admin"
  text: String,   // Ñ‚ÐµÐºÑÑ‚ Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ
  time: { type: Date, default: Date.now }
});

const Message = mongoose.model("Message", messageSchema);

// Ð’Ñ–Ð´Ð´Ð°Ñ”Ð¼Ð¾ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡Ð½Ñ– Ñ„Ð°Ð¹Ð»Ð¸ (index.html, admin.html)
app.use(express.static(path.join(__dirname, "public")));

// WebSocket Ð»Ð¾Ð³Ñ–ÐºÐ°
io.on("connection", async (socket) => {
  console.log("ðŸ”— ÐÐ¾Ð²Ð¸Ð¹ ÐºÐ»Ñ–Ñ”Ð½Ñ‚ Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡Ð¸Ð²ÑÑ");

  // ÐŸÑ€Ð¸ Ð¿Ñ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ– â€” Ð²Ñ–Ð´Ð¿Ñ€Ð°Ð²Ð»ÑÑ”Ð¼Ð¾ Ñ–ÑÑ‚Ð¾Ñ€Ñ–ÑŽ Ð¾ÑÑ‚Ð°Ð½Ð½Ñ–Ñ… 50 Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½ÑŒ
  const history = await Message.find().sort({ time: 1 }).limit(50);
  socket.emit("chat history", history);

  // ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ
  socket.on("chat message", async (data) => {
    const newMsg = new Message(data);
    await newMsg.save();

    io.emit("chat message", {
      from: data.from,
      text: data.text,
      time: newMsg.time
    });
  });

  socket.on("disconnect", () => {
    console.log("âŒ ÐšÐ»Ñ–Ñ”Ð½Ñ‚ Ð²Ñ–Ð´ÐºÐ»ÑŽÑ‡Ð¸Ð²ÑÑ");
  });
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
const PORT = process.env.PORT || 3000;
server.listen(PORT, () => {
  console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
});
